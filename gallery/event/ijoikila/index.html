a  const m = name.match(/\d+/g);
  return m ? parseInt(m[m.length - 1], 10) : 0;
}

/* ================= SKELETON ================= */
function showSkeleton(){
  for(let i=0;i<SKELETON_COUNT;i++){
    const sk = document.createElement("div");
    sk.className = "skeleton";
    gallery.appendChild(sk);
  }
}

function removeSkeleton(){
  document.querySelectorAll(".skeleton").forEach(s=>s.remove());
}

/* ================= LOAD IMAGES ================= */
async function loadNextImages(){
  if(loading) return;
  loading = true;
  showSkeleton();

  const query = encodeURIComponent(
    `'${FOLDER_ID}' in parents and mimeType contains 'image/'`
  );

  let url =
    `https://www.googleapis.com/drive/v3/files?` +
    `q=${query}` +
    `&orderBy=name desc` +
    `&pageSize=${PAGE_SIZE}` +
    `&fields=nextPageToken,files(id,name)` +
    `&key=${API_KEY}`;

  if(nextPageToken) url += `&pageToken=${nextPageToken}`;

  const res  = await fetch(url);
  const data = await res.json();

  nextPageToken = data.nextPageToken || null;

  removeSkeleton();

  data.files
    .sort((a,b)=>extractNumber(b.name)-extractNumber(a.name))
    .forEach(addImage);

  loading = false;
}

/* ================= ADD IMAGE ================= */
function addImage(file){
  if(document.getElementById(`img-${file.id}`)) return;

  modalImageIds.push(file.id);

  const img = document.createElement("img");
  img.id  = `img-${file.id}`;
  img.src = `https://drive.google.com/thumbnail?id=${file.id}&sz=w500`;
  img.loading = "lazy";
  img.style.objectFit = "cover";
  img.style.cursor = "pointer";

  img.onclick = ()=>openModal(file.id);
  gallery.appendChild(img);
}

/* ================= MODAL ================= */
function openModal(id){
  currentIndex = modalImageIds.indexOf(id);
  modalImg.src = `https://lh3.googleusercontent.com/d/${id}`;
  modal.style.display = "flex";
  document.body.classList.add("modal-open");
}

modal.onclick = e=>{
  if(e.target === modal){
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
  }
};

document.addEventListener("keydown", e=>{
  if(modal.style.display !== "flex") return;

  if(e.key === "ArrowRight"){
    currentIndex = (currentIndex + 1) % modalImageIds.length;
  }
  if(e.key === "ArrowLeft"){
    currentIndex = (currentIndex - 1 + modalImageIds.length) % modalImageIds.length;
  }
  if(e.key === "Escape"){
    modal.style.display = "none";
    return;
  }
  modalImg.src = `https://lh3.googleusercontent.com/d/${modalImageIds[currentIndex]}`;
});

  /* ================= MOBILE SWIPE ================= */
let startX = 0;
let deltaX = 0;
let isSwiping = false;
const THRESHOLD = 60;

modal.addEventListener("touchstart", e=>{
  startX = e.touches[0].clientX;
  isSwiping = true;
  slider.style.transition = "none";
},{ passive:true });

modal.addEventListener("touchmove", e=>{
  if(!isSwiping) return;
  deltaX = e.touches[0].clientX - startX;
  slider.style.transform = `translateX(calc(-100% + ${deltaX}px))`;
},{ passive:true });

modal.addEventListener("touchend", ()=>{
  if(!isSwiping) return;
  isSwiping = false;

  if(Math.abs(deltaX) > THRESHOLD){
    slider.style.transition = "transform .25s ease";

    if(deltaX < 0){
      slider.style.transform = "translateX(-200%)"; // next
      currentIndex = (currentIndex + 1) % modalImageIds.length;
    }else{
      slider.style.transform = "translateX(0%)"; // prev
      currentIndex = (currentIndex - 1 + modalImageIds.length) % modalImageIds.length;
    }

    setTimeout(()=>{
      setModalImages();
      slider.style.transition = "none";
      slider.style.transform = "translateX(-100%)";
    },250);

  }else{
    slider.style.transition = "transform .2s ease";
    slider.style.transform = "translateX(-100%)";
  }

  deltaX = 0;
});

/* ================= INFINITE SCROLL ================= */
const observer = new IntersectionObserver(entries=>{
  if(entries[0].isIntersecting && nextPageToken){
    loadNextImages();
  }
},{ rootMargin:"300px" });

observer.observe(sentinel);

/* ================= INIT ================= */
loadNextImages();
</script>

</body>
</html>
