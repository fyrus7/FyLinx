<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FyLinx Gallery</title>

<style>
/* ================= BASE ================= */
body{
  margin:0;
  font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#fff;
  color:#111;
}

/* ================= HEADER ================= */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  border-bottom:1px solid #eee;
}

header h1{
  font-size:14px;
  margin:0;
  letter-spacing:1px;
}

header span{
  font-size:12px;
  color:#777;
}

/* ================= GALLERY ================= */
.gallery{
  display:grid;
  grid-template-columns:repeat(3,1fr); /* mobile */
  gap:4px;
  padding:6px;
}

@media(min-width:600px){
  .gallery{ grid-template-columns:repeat(4,1fr); }
}

@media(min-width:1024px){
  .gallery{ grid-template-columns:repeat(6,1fr); }
}

/* ================= IMAGE ================= */
.gallery img,
.skeleton{
  width:100%;
  aspect-ratio:1/1;
  border-radius:4px;
}

/* ================= SKELETON ================= */
.skeleton{
  background:#eee;
  animation:pulse 1.4s ease-in-out infinite;
}

@keyframes pulse{
  0%{opacity:.6}
  50%{opacity:1}
  100%{opacity:.6}
}

/* ================= FOOTER ================= */
footer{
  text-align:center;
  font-size:11px;
  padding:14px;
  color:#999;
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.92);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}

.modal img{
  max-width:96%;
  max-height:96%;
  transition: transform .25s ease, opacity .25s ease;
  will-change: transform;
}

body.modal-open{
  overflow:hidden;
}

/* ================= SENTINEL ================= */
#sentinel{
  height:1px;
}
</style>
</head>

<body>

<header>
  <h1>FyLinx</h1>
  <span>wedding gallery</span>
</header>

<div class="gallery" id="gallery"></div>
<div id="sentinel"></div>

<footer>Â© FyLinx</footer>

<div class="modal" id="modal">
  <img id="modalImg">
</div>

<script>
/* ================= CONFIG ================= */
const API_KEY   = "AIzaSyCyL4jxLN9w87WG20GqeEIAaUCupjKmn8U";
const FOLDER_ID = "1qEfxwXgPcvEPRlBKNNecsHaqFSRrAjTE";
const PAGE_SIZE = 24;
const SKELETON_COUNT = 12;

/* ================= STATE ================= */
let nextPageToken = null;
let loading = false;

const gallery  = document.getElementById("gallery");
const sentinel = document.getElementById("sentinel");
const modal    = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");

let modalImageIds = [];
let currentIndex = 0;

/* ================= UTIL ================= */
function extractNumber(name){
  const m = name.match(/\d+/g);
  return m ? parseInt(m[m.length - 1], 10) : 0;
}

/* ================= SKELETON ================= */
function showSkeleton(){
  for(let i=0;i<SKELETON_COUNT;i++){
    const sk = document.createElement("div");
    sk.className = "skeleton";
    gallery.appendChild(sk);
  }
}

function removeSkeleton(){
  document.querySelectorAll(".skeleton").forEach(s=>s.remove());
}

/* ================= LOAD IMAGES ================= */
async function loadNextImages(){
  if(loading) return;
  loading = true;
  showSkeleton();

  const query = encodeURIComponent(
    `'${FOLDER_ID}' in parents and mimeType contains 'image/'`
  );

  let url =
    `https://www.googleapis.com/drive/v3/files?` +
    `q=${query}` +
    `&orderBy=name desc` +
    `&pageSize=${PAGE_SIZE}` +
    `&fields=nextPageToken,files(id,name)` +
    `&key=${API_KEY}`;

  if(nextPageToken) url += `&pageToken=${nextPageToken}`;

  const res  = await fetch(url);
  const data = await res.json();

  nextPageToken = data.nextPageToken || null;

  removeSkeleton();

  data.files
    .sort((a,b)=>extractNumber(b.name)-extractNumber(a.name))
    .forEach(addImage);

  loading = false;
}

/* ================= ADD IMAGE ================= */
function addImage(file){
  if(document.getElementById(`img-${file.id}`)) return;

  modalImageIds.push(file.id);

  const img = document.createElement("img");
  img.id  = `img-${file.id}`;
  img.src = `https://drive.google.com/thumbnail?id=${file.id}&sz=w500`;
  img.loading = "lazy";
  img.style.objectFit = "cover";
  img.style.cursor = "pointer";

  img.onclick = ()=>openModal(file.id);
  gallery.appendChild(img);
}

/* ================= MODAL ================= */
function openModal(id){
  currentIndex = modalImageIds.indexOf(id);
  modalImg.src = `https://lh3.googleusercontent.com/d/${id}`;
  modal.style.display = "flex";
  document.body.classList.add("modal-open");
}

modal.onclick = e=>{
  if(e.target === modal){
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
  }
};

document.addEventListener("keydown", e=>{
  if(modal.style.display !== "flex") return;

  if(e.key === "ArrowRight"){
    currentIndex = (currentIndex + 1) % modalImageIds.length;
  }
  if(e.key === "ArrowLeft"){
    currentIndex = (currentIndex - 1 + modalImageIds.length) % modalImageIds.length;
  }
  if(e.key === "Escape"){
    modal.style.display = "none";
    return;
  }
  modalImg.src = `https://lh3.googleusercontent.com/d/${modalImageIds[currentIndex]}`;
});

  /* ================= MOBILE SWIPE ================= */
let startX = 0;
let currentX = 0;
let isSwiping = false;
const SWIPE_THRESHOLD = 60;

modal.addEventListener("touchstart", e=>{
  startX = e.touches[0].clientX;
  isSwiping = true;
  modalImg.style.transition = "none";
},{ passive:true });

modal.addEventListener("touchmove", e=>{
  if(!isSwiping) return;
  currentX = e.touches[0].clientX;
  const delta = currentX - startX;

  // ikut jari
  modalImg.style.transform = `translateX(${delta}px)`;
},{ passive:true });

modal.addEventListener("touchend", ()=>{
  if(!isSwiping) return;
  isSwiping = false;

  const delta = currentX - startX;
  modalImg.style.transition = "transform .25s ease, opacity .25s ease";

  if(Math.abs(delta) < SWIPE_THRESHOLD){
    // snap balik
    modalImg.style.transform = "translateX(0)";
    return;
  }

  const direction = delta < 0 ? 1 : -1;

  // slide keluar
  modalImg.style.transform = `translateX(${direction * -100}%)`;
  modalImg.style.opacity = "0";

  setTimeout(()=>{
    // tukar image
    if(delta < 0){
      currentIndex = (currentIndex + 1) % modalImageIds.length;
    }else{
      currentIndex = (currentIndex - 1 + modalImageIds.length) % modalImageIds.length;
    }

    modalImg.src = `https://lh3.googleusercontent.com/d/${modalImageIds[currentIndex]}`;

    // reset posisi dari arah bertentangan
    modalImg.style.transition = "none";
    modalImg.style.transform = `translateX(${direction * 100}%)`;

    requestAnimationFrame(()=>{
      modalImg.style.transition = "transform .25s ease, opacity .25s ease";
      modalImg.style.opacity = "1";
      modalImg.style.transform = "translateX(0)";
    });
  }, 200);
});


/* ================= INFINITE SCROLL ================= */
const observer = new IntersectionObserver(entries=>{
  if(entries[0].isIntersecting && nextPageToken){
    loadNextImages();
  }
},{ rootMargin:"300px" });

observer.observe(sentinel);

/* ================= INIT ================= */
loadNextImages();
</script>

</body>
</html>
